import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, query } from 'firebase/firestore';

// --- Global Variable Access (MANDATORY) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'life2class-default';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

const API_MODEL = 'gemini-2.5-flash-preview-09-2025';
const API_KEY = ""; // Canvas will automatically provide the key at runtime

// Helper function to convert File to Base64 (required for Gemini Vision API)
const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = error => reject(error);
});

// Helper for Exponential Backoff (MANDATORY)
const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

// Firestore Path Generation
// Stores private data: /artifacts/{appId}/users/{userId}/history
const getHistoryCollectionPath = (userId) => {
    return `artifacts/${appId}/users/${userId}/history`;
};

// --- LLM Response Schema (Structured Output for Learning Content) ---
const RESPONSE_SCHEMA = {
    type: "OBJECT",
    properties: {
        identifiedObject: { "type": "STRING", "description": "The main object identified in the image." },
        curriculumMapping: {
            "type": "OBJECT",
            "properties": {
                "subject": { "type": "STRING", "description": "The mapped school subject, e.g., Science, History." },
                "classLevel": { "type": "INTEGER", "description": "The suggested grade level, e.g., 7 or 8." },
                "conceptId": { "type": "STRING", "description": "The specific textbook concept, e.g., Photosynthesis, Medieval Architecture." }
            },
            "propertyOrdering": ["subject", "classLevel", "conceptId"]
        },
        notesSummary: { "type": "STRING", "description": "A concise, age-appropriate explanation of the concept." },
        quizQuestions: {
            "type": "ARRAY",
            "items": {
                "type": "OBJECT",
                "properties": {
                    "question": { "type": "STRING" },
                    "answer": { "type": "STRING", "description": "The correct answer to the question." }
                },
                "propertyOrdering": ["question", "answer"]
            }
        }
    },
    "propertyOrdering": ["identifiedObject", "curriculumMapping", "notesSummary", "quizQuestions"]
};

// --- Dropdown Menu Component ---
const DropdownMenu = ({ userId, onLogout, onHistoryClick }) => {
    const [isOpen, setIsOpen] = useState(false);

    // Simple navigation handler (since we don't have routing)
    const handleNav = (item) => {
        setIsOpen(false);
        if (item === 'Logout') {
            onLogout();
        } else if (item === 'History') {
            onHistoryClick();
        } else {
             // Mock navigation for Profile/Create Account
             console.log(`Navigating to ${item} page (mock)...`);
        }
    };

    return (
        <div className="relative z-50">
            {/* Menu Button (Hamburger) */}
            <button 
                onClick={() => setIsOpen(!isOpen)} 
                className="p-3 rounded-full bg-green-600 text-white hover:bg-green-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-green-400"
                aria-expanded={isOpen}
            >
                {/* Icon based on state */}
                {isOpen ? (
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                ) : (
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                )}
            </button>

            {/* Dropdown Content */}
            {isOpen && (
                <div className="absolute left-0 mt-2 w-56 bg-white rounded-xl shadow-2xl py-2 border border-green-200 animate-fade-in-down">
                    
                    {/* 1. Profile */}
                    <div 
                        onClick={() => handleNav('Profile')} 
                        className="px-4 py-2 text-sm text-gray-500 border-b border-green-100 cursor-pointer hover:bg-green-50"
                    >
                        <p className='font-semibold text-green-700'>Profile</p>
                        <p className='text-xs truncate'>User ID: <span className="font-mono text-gray-600">{userId.substring(0, 12)}...</span></p>
                    </div>
                    
                    {/* 2. Create Account */}
                    <button onClick={() => handleNav('Create Account')} className="w-full text-left block px-4 py-2 text-sm text-green-700 hover:bg-green-50 transition">
                        Create Account
                    </button>
                    
                    {/* 3. History */}
                    <button onClick={() => handleNav('History')} className="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-green-50 hover:text-green-700 transition">
                        History
                    </button>
                    
                    {/* 4. Logout */}
                    <button onClick={() => handleNav('Logout')} className="w-full text-left block px-4 py-2 text-sm text-red-600 hover:bg-red-50 hover:text-red-700 transition">
                        Logout
                    </button>

                    {/* 5. Footer - Life2Class Name */}
                    <div className="mt-2 pt-2 border-t border-green-100 text-center">
                        <span className="font-extrabold text-green-800 text-lg">Life2Class</span>
                    </div>
                </div>
            )}
        </div>
    );
};

// --- Learning Chatbot Component ---
const LearningChatbot = ({ learningResult, isGenerating }) => {
    const CHAT_API_MODEL = 'gemini-2.5-flash-preview-09-2025';
    const CHAT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${CHAT_API_MODEL}:generateContent?key=${API_KEY}`;
    
    // History uses the format expected by the Gemini API
    const [history, setHistory] = useState([]);
    const [currentInput, setCurrentInput] = useState('');
    const [chatLoading, setChatLoading] = useState(false);
    
    // Initial message is set based on whether a result is available
    const initialMessage = "Please scan an object first to start a contextual learning chat session.";
    const activeMessage = learningResult
        ? `I have identified the object as **${learningResult.identifiedObject}** and prepared a summary on **${learningResult.curriculumMapping.conceptId}**. Ask me any follow-up questions about this concept, the object, or the quiz!`
        : initialMessage;

    // Effect to set the initial context/history when a new result arrives
    useEffect(() => {
        if (learningResult) {
            const systemInstruction = `You are Life2Class Tutor AI, an expert middle school science and history tutor. Your purpose is to clarify doubts and answer follow-up questions related to the current learning topic. The user has just scanned the object: ${learningResult.identifiedObject}. The learning summary is: "${learningResult.notesSummary}". The quiz questions are: ${JSON.stringify(learningResult.quizQuestions)}. Keep your responses concise, encouraging, and age-appropriate (Grades 6-8).`;
            
            // Start history with system instruction (for API) and the model's first welcome message (for display)
            setHistory([
                { role: 'system', parts: [{ text: systemInstruction }] },
                { role: 'model', parts: [{ text: activeMessage }] },
            ]);
        } else {
            setHistory([]);
        }
    }, [learningResult]);

    const sendChatMessage = useCallback(async () => {
        if (!currentInput.trim() || chatLoading || !learningResult) return;

        const userMessage = currentInput.trim();
        
        // Prepare new history state
        const newMessage = { role: 'user', parts: [{ text: userMessage }] };
        const newHistory = [...history, newMessage];
        
        // Add the user message immediately to the UI
        setHistory(newHistory);
        setCurrentInput('');
        setChatLoading(true);

        try {
            // The API payload needs all preceding messages, including the system instruction (which is at history[0])
            const payload = {
                contents: newHistory.filter(m => m.role !== 'system'), // Send all history *except* the system instruction
                systemInstruction: history.find(m => m.role === 'system')?.parts[0] || { parts: [{ text: "You are a helpful tutor." }] } // Re-add the system instruction outside the contents array
            };

            const maxRetries = 5;
            let responseData;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(CHAT_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        responseData = await response.json();
                        break;
                    } else if (response.status === 429 && attempt < maxRetries - 1) {
                        await delay(1000 * Math.pow(2, attempt));
                    } else {
                        throw new Error(`Chat API request failed with status: ${response.status}`);
                    }
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error;
                    await delay(1000 * Math.pow(2, attempt));
                }
            }

            const modelResponseText = responseData.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I ran into an error generating a response.";

            // Add the model's response to the history
            setHistory(prev => [...prev, { role: 'model', parts: [{ text: modelResponseText }] }]);

        } catch (err) {
            console.error("Chat Generation Error:", err);
            setHistory(prev => [...prev, { role: 'model', parts: [{ text: "I apologize, but I couldn't connect to the tutor. Please try again." }] }]);
        } finally {
            setChatLoading(false);
        }
    }, [currentInput, chatLoading, history, learningResult, CHAT_API_URL]);
    
    // Scroll to the bottom whenever history changes
    useEffect(() => {
        const chatWindow = document.getElementById('chat-messages');
        if (chatWindow) {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    }, [history]);
    
    // Filter out the system message for display
    const visibleHistory = history.filter(m => m.role !== 'system');
    
    const isDisabled = isGenerating || chatLoading || !learningResult;

    return (
        <div className="flex flex-col h-full bg-white rounded-xl shadow-xl border border-green-400">
            <div className="p-4 bg-green-200 rounded-t-xl border-b border-green-400">
                <h3 className="text-xl font-bold text-green-800 flex items-center">
                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.188C2.607 14.825 2 13.064 2 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                    Learning Tutor Chat
                </h3>
            </div>
            
            {/* Chat Messages Window */}
            <div id="chat-messages" className="flex-grow p-4 space-y-4 overflow-y-auto max-h-[300px] min-h-[150px]">
                {visibleHistory.length === 0 && (
                    <p className="text-gray-500 italic text-sm pt-2">{activeMessage}</p>
                )}
                {visibleHistory.map((msg, index) => (
                    <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                        <div className={`max-w-[85%] p-3 rounded-xl shadow-md ${
                            msg.role === 'user' 
                                ? 'bg-green-600 text-white rounded-br-none' 
                                : 'bg-gray-100 text-gray-800 rounded-tl-none border border-gray-200'
                        }`}>
                            {msg.parts.map((part, pIndex) => (
                                <p key={pIndex} className="text-sm whitespace-pre-wrap">{part.text}</p>
                            ))}
                        </div>
                    </div>
                ))}
                {chatLoading && (
                    <div className="flex justify-start">
                        <div className="bg-gray-100 p-3 rounded-xl rounded-tl-none shadow-md">
                            <div className="w-4 h-4 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                    </div>
                )}
            </div>
            
            {/* Input Area */}
            <div className="p-4 border-t border-green-200">
                <div className="flex space-x-2">
                    <input
                        type="text"
                        value={currentInput}
                        onChange={(e) => setCurrentInput(e.target.value)}
                        onKeyPress={(e) => {
                            if (e.key === 'Enter' && !isDisabled) {
                                sendChatMessage();
                            }
                        }}
                        placeholder={isDisabled ? "Scan object to enable chat..." : "Ask your follow-up question..."}
                        className="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"
                        disabled={isDisabled}
                    />
                    <button
                        onClick={sendChatMessage}
                        disabled={isDisabled}
                        className={`p-3 rounded-full transition-colors ${
                            isDisabled 
                                ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                : 'bg-green-600 text-white hover:bg-green-700'
                        }`}
                    >
                         <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 9l3 3-3 3m5 0h-16"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    );
};


// --- Main App Component ---
export default function App() {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [file, setFile] = useState(null);
    const [imagePreview, setImagePreview] = useState(null);
    const [loading, setLoading] = useState(false);
    const [errorMessage, setErrorMessage] = useState(null);
    // State variables for Time-to-Content tracking
    const [startTime, setStartTime] = useState(null); 
    const [timeToContent, setTimeToContent] = useState(null); 
    
    const [learningHistory, setLearningHistory] = useState([]);
    const [result, setResult] = useState(null);
    const [userQuizAnswers, setUserQuizAnswers] = useState({});
    const [score, setScore] = useState(null);
    const [userPrompt, setUserPrompt] = useState(''); 

    // Mock logout function
    const handleLogout = () => {
        // In a real app, you would call signOut(auth)
        console.log("Logout triggered. In a production app, the user session would be terminated.");
        // Mock UI state reset:
        setUserId(null);
        setIsAuthReady(false); 
        // Force a re-auth (simulating anonymous sign-in after logout)
        window.location.reload(); 
    };

    // Mock history click handler - scrolls to the history panel
    const handleHistoryClick = () => {
        const historyElement = document.getElementById('learning-history');
        if (historyElement) {
            historyElement.scrollIntoView({ behavior: 'smooth' });
        }
    };

    // 1. Firebase Initialization and Authentication (MANDATORY)
    useEffect(() => {
        try {
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const authInstance = getAuth(app);

            setDb(firestore);
            setAuth(authInstance);

            const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                    setUserId(user.uid);
                    setIsAuthReady(true); // User is authenticated, ready to go
                } else {
                    // If no user is logged in, attempt sign in using token or anonymously
                    if (initialAuthToken) {
                        await signInWithCustomToken(authInstance, initialAuthToken)
                            .catch(err => console.error("Custom token sign-in failed:", err));
                    } else {
                        await signInAnonymously(authInstance)
                            .catch(err => console.error("Anonymous sign-in failed:", err));
                    }
                    
                    // After the attempt, if the user is still null, we are ready to proceed with a null user ID.
                    if (!authInstance.currentUser) {
                        setIsAuthReady(true);
                        // Ensure userId is set to a temporary value if auth failed but app is ready to run (for firestore pathing)
                        setUserId(crypto.randomUUID()); 
                    }
                }
            });

            return () => unsubscribe();
        } catch (e) {
            console.error("Firebase setup failed:", e);
            setErrorMessage("Failed to initialize the application.");
        }
    }, []);

    // 2. Fetch Learning History (MANDATORY onSnapshot)
    useEffect(() => {
        // Only run if DB is initialized, Auth is ready, and userId is set
        if (!db || !isAuthReady || !userId) return;

        const historyCollectionRef = collection(db, getHistoryCollectionPath(userId));
        const q = query(historyCollectionRef);

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const history = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                // Safely convert Firestore Timestamp to string
                timestamp: doc.data().timestamp?.toDate().toLocaleString() || 'N/A' 
            }));
            
            // Sort by timestamp in memory (latest first)
            history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            setLearningHistory(history);
        }, (error) => {
            console.error("Error fetching history:", error);
            setErrorMessage("Could not load learning history.");
        });

        return () => unsubscribe();
    }, [db, isAuthReady, userId]);

    // Function to handle file selection
    const handleFileChange = (e) => {
        const selectedFile = e.target.files[0];
        if (selectedFile) {
            setFile(selectedFile);
            setImagePreview(URL.createObjectURL(selectedFile));
            // Reset previous results
            setResult(null);
            setScore(null);
            setUserQuizAnswers({});
            setErrorMessage(null);
            setTimeToContent(null); // Reset TTC
        }
    };

    // 3. Core AI Generation Logic (Image-to-Content)
    const handleGenerateContent = useCallback(async () => {
        // Check for readiness
        if (!file || !userId || !db) {
            setErrorMessage("Please select an image and ensure the app is initialized.");
            return;
        }

        setLoading(true);
        setErrorMessage(null);
        setResult(null);
        setScore(null);
        setUserQuizAnswers({});
        setStartTime(Date.now()); // START TIMER

        try {
            const base64Image = await toBase64(file);

            // System Instruction to enforce persona and structure
            const systemPrompt = "You are Life2Class, an AI tutor. Act as a world-class educational analyst and science content creator for middle school students (Grades 6-8). Identify the object, map it to a common science concept, and provide a concise explanation and a 3-question quiz. Your output must strictly follow the provided JSON schema.";
            
            // Core Query Structure
            const coreQuery = "Identify the main real-world object in this image. Map it to a common middle school science concept. Provide a concise explanation (notes) and a 3-question quiz with answers based on that concept. The content must be structured exactly as the JSON schema.";

            // Prepend user prompt if it exists
            const fullUserQuery = userPrompt.trim()
                ? `User Context/Question: "${userPrompt.trim()}". Based on this context, also execute the core task: ${coreQuery}`
                : coreQuery;
            
            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: fullUserQuery }, // Use the modified query here
                            {
                                inlineData: {
                                    mimeType: file.type,
                                    data: base64Image
                                }
                            }
                        ]
                    }
                ],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: RESPONSE_SCHEMA
                },
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${API_KEY}`;
            const maxRetries = 5;
            let responseData;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        responseData = await response.json();
                        break; // Success, break out of loop
                    } else if (response.status === 429 && attempt < maxRetries - 1) {
                        await delay(1000 * Math.pow(2, attempt)); // Exponential backoff
                    } else {
                        throw new Error(`API request failed with status: ${response.status}`);
                    }
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error;
                    await delay(1000 * Math.pow(2, attempt)); // Exponential backoff for network errors
                }
            }

            if (!responseData || !responseData.candidates || responseData.candidates.length === 0) {
                throw new Error("No response content from AI.");
            }

            const jsonText = responseData.candidates[0].content.parts[0].text;
            const parsedResult = JSON.parse(jsonText);

            // Calculate Time-to-Content
            const duration = Date.now() - startTime;
            setTimeToContent(duration); // END TIMER AND SET RESULT

            setResult(parsedResult);

            // Save to Firestore (Progress Tracking)
            const historyRef = collection(db, getHistoryCollectionPath(userId));
            await addDoc(historyRef, {
                identifiedObject: parsedResult.identifiedObject,
                mapping: parsedResult.curriculumMapping,
                timestamp: new Date(),
                userId: userId,
                quizScore: null, // Will be updated later
            });

        } catch (err) {
            console.error("Generation Error:", err);
            setErrorMessage(`Error: Could not generate content. ${err.message || "Please try a different image."}`);
        } finally {
            setLoading(false);
        }
    }, [file, userId, db, userPrompt, startTime]); 

    // Function to handle quiz submission
    const handleSubmitQuiz = () => {
        if (!result) return;

        let correctCount = 0;
        const totalQuestions = result.quizQuestions.length;

        result.quizQuestions.forEach((q, index) => {
            // Simplified check to be less prone to whitespace errors and handle simple matches.
            const userAnswer = userQuizAnswers[index]?.toLowerCase().trim() || "";
            const correctAnswer = q.answer.toLowerCase().trim();

            if (userAnswer === correctAnswer) {
                correctCount++;
            }
        });

        const newScore = `${correctCount}/${totalQuestions}`;
        setScore(newScore);

        // Update UI state.
        console.log(`Quiz submitted. Score: ${newScore}. This score should be updated in Firestore.`);
    };

    // Render loading state for auth/init
    if (!isAuthReady) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-green-50">
                <p className="text-lg text-green-700 font-medium">Initializing Life2Class...</p>
            </div>
        );
    }

    // Light green theme: bg-green-50
    return (
        <div className="min-h-screen bg-green-50 flex flex-col items-center p-4 sm:p-6 font-sans">
            
            <header className="w-full max-w-6xl relative py-4">
                <div className="flex justify-between items-center w-full">
                    {/* Menu Bar (Top Left) */}
                    <DropdownMenu 
                        userId={userId} 
                        onLogout={handleLogout} 
                        onHistoryClick={handleHistoryClick}
                    />

                    {/* Centered App Title */}
                    <h1 className="text-4xl font-extrabold text-green-800 tracking-tight text-center flex-grow">
                        Life2Class ðŸŒ³ðŸŽ“
                    </h1>

                    {/* User ID display (Right side, primarily for desktop aesthetics) */}
                    <div className="w-16 flex justify-end">
                        <div className="hidden lg:block p-1 bg-green-200 rounded-lg text-xs text-green-800 font-mono opacity-75">
                            ID
                        </div>
                    </div>
                </div>

                <p className="mt-2 text-green-600 text-lg text-center">Bridge Real World Curiosity to Curriculum using AI</p>
                <div className="mt-2 p-1 bg-green-200 rounded-lg text-xs text-green-800 inline-block font-mono text-center w-full lg:hidden">
                    User ID: {userId}
                </div>
            </header>

            <main className="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-3 gap-6 mt-4">

                {/*--- Left Column: Input & History --- */}
                <div className="lg:col-span-1 space-y-6">

                    {/* Input Card (Scan Object) */}
                    <div className="bg-white shadow-xl rounded-xl p-5 border-t-4 border-green-600">
                        <h2 className="text-2xl font-bold text-green-700 mb-4">1. Scan an Object</h2>
                        
                        <input
                            type="file"
                            accept="image/*"
                            onChange={handleFileChange}
                            className="w-full mb-4 text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm
                                file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"
                        />

                        {imagePreview && (
                            <div className="mb-4">
                                <p className="text-sm text-gray-600 mb-2 font-medium">Image Preview:</p>
                                <img src={imagePreview} alt="Preview"
                                    className="w-full h-48 object-cover rounded-lg shadow-md border border-gray-100" />
                            </div>
                        )}

                        {/* Custom Prompt Field */}
                        <div className="mb-4">
                            <label htmlFor="user-prompt" className="text-sm text-gray-600 mb-2 font-medium block">
                                Optional: Add a specific question or context
                            </label>
                            <textarea
                                id="user-prompt"
                                rows="3"
                                value={userPrompt}
                                onChange={(e) => setUserPrompt(e.target.value)}
                                placeholder="e.g., 'Relate this object to the concept of gravity' or 'Explain the historical significance.'"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition-colors"
                            />
                        </div>

                        <button
                            onClick={handleGenerateContent}
                            disabled={!file || loading}
                            className={`w-full py-3 rounded-full font-bold text-lg transition-all duration-300
                                ${file && !loading
                                    ? 'bg-green-600 text-white hover:bg-green-700 shadow-lg'
                                    : 'bg-green-300 text-green-100 cursor-not-allowed'
                                }`}
                        >
                            {loading ? '2. Analyzing Object...' : '2. Get Concept Explanation'}
                        </button>

                        {loading && (
                            <div className="mt-4 text-center">
                                <div className="animate-spin inline-block w-6 h-6 border-4 border-t-4 border-green-600 border-opacity-25 rounded-full border-t-green-600"></div>
                                <p className="text-sm text-green-600 mt-2">Processing Vision & Generating Content...</p>
                            </div>
                        )}

                        {errorMessage && (
                            <div className="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm font-medium">
                                {errorMessage}
                            </div>
                        )}
                        
                        {/* Time-to-Content Display */}
                        {timeToContent !== null && ( 
                            <p className="mt-4 text-center text-sm font-medium text-green-700 bg-green-100 p-2 rounded-lg">
                                Time-to-Content: **{(timeToContent / 1000).toFixed(2)} seconds** âš¡
                            </p>
                        )}
                    </div>

                    {/* History Card (Progress Tracking) */}
                    <div id="learning-history" className="bg-white shadow-xl rounded-xl p-5 border border-gray-200">
                        <h2 className="text-2xl font-bold text-gray-700 mb-4 flex items-center">
                            Learning History
                            <svg className="w-5 h-5 ml-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </h2>
                        <div className="max-h-80 overflow-y-auto space-y-3">
                            {learningHistory.length === 0 ? (
                                <p className="text-gray-500 italic text-sm">No learning records found yet. Scan an image to start!</p>
                            ) : (
                                learningHistory.map((item) => (
                                    <div key={item.id} className="p-3 bg-green-50 rounded-lg border border-green-200 hover:shadow-md transition-shadow">
                                        <p className="font-semibold text-sm text-gray-800 truncate">{item.identifiedObject}</p>
                                        <p className="text-xs text-green-700">
                                            {item.mapping?.subject} / Class {item.mapping?.classLevel}
                                        </p>
                                        <p className="text-xs text-gray-400 mt-1">{item.timestamp}</p>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>

                {/* --- Right Column: Result Display --- */}
                <div className="lg:col-span-2 space-y-6">

                    <div className="bg-white shadow-xl rounded-xl p-6 border-t-4 border-green-400 min-h-[400px]">
                        <h2 className="text-3xl font-extrabold text-green-600 mb-6">
                            {result ? result.curriculumMapping.conceptId : '3. Concept Output'}
                        </h2>

                        {result ? (
                            <>
                                <div className="mb-6 pb-4 border-b border-green-100">
                                    <p className="text-lg font-semibold text-gray-700">Identified Object: <span className="text-green-800">{result.identifiedObject}</span></p>
                                    <p className="text-sm text-gray-500">Mapped to: {result.curriculumMapping.subject}, Class {result.curriculumMapping.classLevel}</p>
                                </div>

                                {/* Notes/Summary */}
                                <h3 className="text-xl font-bold text-gray-800 mb-3 flex items-center">
                                    <svg className="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    Notes & Explanation
                                </h3>
                                <div className="p-4 bg-green-100 rounded-lg text-gray-800 border border-green-300 shadow-inner">
                                    <p className="italic font-medium">{result.notesSummary}</p>
                                </div>

                                {/* Quiz */}
                                <h3 className="text-xl font-bold text-gray-800 mt-6 mb-3 flex items-center">
                                    <svg className="w-5 h-5 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.228 9.247a8.688 8.688 0 013.435-.494 8.688 8.688 0 013.436.494m-6.871 0V8.293m0 0a1 1 0 011.414 0l1.414 1.414m-2.828-1.414l-1.414 1.414M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                                    Reinforcement Quiz
                                </h3>
                                <div className="space-y-4">
                                    {result.quizQuestions.map((q, index) => (
                                        <div key={index} className="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                            <p className="font-semibold text-gray-800 mb-2">Q{index + 1}: {q.question}</p>
                                            <input
                                                type="text"
                                                placeholder="Your Answer"
                                                value={userQuizAnswers[index] || ''}
                                                onChange={(e) =>
                                                    setUserQuizAnswers({ ...userQuizAnswers, [index]: e.target.value })
                                                }
                                                className="w-full p-2 border border-yellow-300 rounded-md focus:ring-yellow-500 focus:border-yellow-500"
                                                disabled={score !== null}
                                            />
                                            {score !== null && (
                                                <p className="mt-2 text-sm font-semibold text-green-700">
                                                    Correct Answer: {q.answer}
                                                </p>
                                            )}
                                        </div>
                                    ))}
                                </div>

                                <div className="mt-6 flex justify-between items-center">
                                    <button
                                        onClick={handleSubmitQuiz}
                                        disabled={loading || score !== null}
                                        className={`px-6 py-2 rounded-full font-bold transition-all duration-200 text-white
                                            ${score === null
                                                ? 'bg-yellow-500 hover:bg-yellow-600 shadow-lg'
                                                : 'bg-gray-300 text-gray-600 cursor-not-allowed'
                                            }`}
                                    >
                                        Submit Quiz
                                    </button>

                                    {score !== null && (
                                        <div className={`text-2xl font-extrabold p-3 rounded-lg text-white ${score.startsWith('3') ? 'bg-green-600' : 'bg-red-500'}`}>
                                            Score: {score}
                                        </div>
                                    )}
                                </div>

                            </>
                        ) : (
                            <div className="flex flex-col items-center justify-center text-center h-full min-h-[400px]">
                                <svg className="w-16 h-16 text-green-200 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L14 14m-4 5h-4a2 2 0 01-2-2v-7a2 2 0 012-2h12a2 2 0 012 2v7a2 2 0 01-2 2h-4m-4 0v-5m4 5v-5"></path></svg>
                                <p className="text-gray-500 text-lg">Upload an image of a real object to start a learning session.</p>
                                <p className="text-gray-400 text-sm mt-2">Example: A plant, a coin, a monument, or a tool.</p>
                            </div>
                        )}
                    </div>
                    
                    {/* --- LEARNING TUTOR CHATBOT --- */}
                    <LearningChatbot learningResult={result} isGenerating={loading} />

                </div>

            </main>

        </div>
    );
}
